name: Social Media Training - Learning Phase

on:
  workflow_dispatch:
    inputs:
      sites:
        description: 'Sites to test (comma-separated or "all")'
        required: false
        default: 'all'
      iterations:
        description: 'Number of iterations'
        required: false
        default: '3'
  schedule:
    - cron: '0 */8 * * *'  # Every 8 hours

jobs:
  discover-ips:
    name: Discover GitHub Runner IPs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        runner: [1, 2, 3, 4]

    steps:
      - name: Get IP Information
        id: ip-info
        run: |
          echo "ðŸ” Discovering IP for runner-${{ matrix.runner }}"
          PUBLIC_IP=$(curl -s https://api.ipify.org)
          IP_INFO=$(curl -s https://ipinfo.io/${PUBLIC_IP}/json)

          echo "public_ip=${PUBLIC_IP}" >> $GITHUB_OUTPUT
          echo "ip_org=$(echo $IP_INFO | jq -r '.org')" >> $GITHUB_OUTPUT
          echo "ip_city=$(echo $IP_INFO | jq -r '.city')" >> $GITHUB_OUTPUT
          echo "ip_country=$(echo $IP_INFO | jq -r '.country')" >> $GITHUB_OUTPUT
          echo "ip_asn=$(echo $IP_INFO | jq -r '.org' | grep -oP 'AS\d+')" >> $GITHUB_OUTPUT

          echo "ðŸ“ IP: ${PUBLIC_IP}"
          echo "ðŸ¢ Org: $(echo $IP_INFO | jq -r '.org')"
          echo "ðŸŒ Location: $(echo $IP_INFO | jq -r '.city'), $(echo $IP_INFO | jq -r '.country')"
          echo "ðŸ”¢ ASN: $(echo $IP_INFO | jq -r '.org' | grep -oP 'AS\d+')"

      - name: Upload IP info
        uses: actions/upload-artifact@v4
        with:
          name: ip-info-runner-${{ matrix.runner }}
          path: |
            /tmp/ip-info.json

  social-media-test:
    name: Social Media Training
    runs-on: ubuntu-latest
    needs: discover-ips
    strategy:
      fail-fast: false
      matrix:
        runner: [1, 2, 3, 4]
        site:
          - github
          - reddit
          - linkedin
          - stackoverflow
          - youtube
          - medium
          - devto
          - producthunt
          - hackernews
          - theinternet
          - practicetest
          - saucedemo
          - uitest-dynamic
          - uitest-shadow

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Get runner IP
        id: runner-ip
        run: |
          PUBLIC_IP=$(curl -s https://api.ipify.org)
          echo "ip=${PUBLIC_IP}" >> $GITHUB_OUTPUT
          echo "ðŸŒ Testing from IP: ${PUBLIC_IP}"

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Run test for ${{ matrix.site }}
        id: test
        continue-on-error: true
        run: |
          echo "ðŸ§ª Testing ${{ matrix.site }} from runner ${{ matrix.runner }}"

          # Map site names to test patterns
          case "${{ matrix.site }}" in
            github)
              PATTERN="GitHub"
              ;;
            reddit)
              PATTERN="Reddit"
              ;;
            linkedin)
              PATTERN="LinkedIn"
              ;;
            stackoverflow)
              PATTERN="Stack Overflow"
              ;;
            youtube)
              PATTERN="YouTube"
              ;;
            medium)
              PATTERN="Medium"
              ;;
            devto)
              PATTERN="Dev.to"
              ;;
            producthunt)
              PATTERN="Product Hunt"
              ;;
            hackernews)
              PATTERN="Hacker News"
              ;;
            theinternet)
              PATTERN="The Internet"
              ;;
            practicetest)
              PATTERN="Practice Test"
              ;;
            saucedemo)
              PATTERN="SauceDemo"
              ;;
            uitest-dynamic)
              PATTERN="Dynamic"
              ;;
            uitest-shadow)
              PATTERN="Shadow"
              ;;
          esac

          npm test tests/social-media-domination.test.ts -- --testNamePattern="${PATTERN}" --verbose 2>&1 | tee test-output.log

          # Capture exit code
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT

          # Extract metrics
          if grep -q "CAPTCHA detected" test-output.log; then
            echo "captcha_detected=true" >> $GITHUB_OUTPUT
          else
            echo "captcha_detected=false" >> $GITHUB_OUTPUT
          fi

          if [ ${TEST_EXIT_CODE} -eq 0 ]; then
            echo "âœ… Test PASSED for ${{ matrix.site }}"
            echo "result=PASS" >> $GITHUB_OUTPUT
          else
            echo "âŒ Test FAILED for ${{ matrix.site }}"
            echo "result=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Collect metrics
        if: always()
        run: |
          mkdir -p results/${{ matrix.site }}

          # Save test result
          cat > results/${{ matrix.site }}/result.json << EOF
          {
            "site": "${{ matrix.site }}",
            "runner": ${{ matrix.runner }},
            "ip": "${{ steps.runner-ip.outputs.ip }}",
            "result": "${{ steps.test.outputs.result }}",
            "captcha_detected": ${{ steps.test.outputs.captcha_detected || false }},
            "exit_code": ${{ steps.test.outputs.exit_code || 1 }},
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF

          # Copy AgentDB metrics if available
          if [ -d ".claude-flow/metrics" ]; then
            cp -r .claude-flow/metrics results/${{ matrix.site }}/
          fi

          # Copy test results if available
          if [ -d "data/test-results" ]; then
            cp -r data/test-results results/${{ matrix.site }}/
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.site }}-runner-${{ matrix.runner }}
          path: results/
          retention-days: 30

      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.site }}-runner-${{ matrix.runner }}
          path: test-output.log
          retention-days: 7

  analyze-results:
    name: Analyze Test Results
    runs-on: ubuntu-latest
    needs: social-media-test
    if: always()

    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: all-results/

      - name: Analyze results
        run: |
          echo "ðŸ“Š ANALYSIS REPORT"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Count results
          TOTAL=0
          PASSED=0
          FAILED=0
          CAPTCHA_COUNT=0

          # Collect unique IPs
          declare -A IP_RESULTS

          for result_file in all-results/test-results-*/*/result.json; do
            if [ -f "$result_file" ]; then
              TOTAL=$((TOTAL + 1))

              RESULT=$(jq -r '.result' "$result_file")
              IP=$(jq -r '.ip' "$result_file")
              SITE=$(jq -r '.site' "$result_file")
              CAPTCHA=$(jq -r '.captcha_detected' "$result_file")

              if [ "$RESULT" = "PASS" ]; then
                PASSED=$((PASSED + 1))
              else
                FAILED=$((FAILED + 1))
              fi

              if [ "$CAPTCHA" = "true" ]; then
                CAPTCHA_COUNT=$((CAPTCHA_COUNT + 1))
              fi

              # Track IP performance
              IP_RESULTS["$IP"]=$((${IP_RESULTS[$IP]:-0} + 1))
            fi
          done

          echo ""
          echo "ðŸ“ˆ Overall Results:"
          echo "   Total Tests: ${TOTAL}"
          echo "   Passed: ${PASSED}"
          echo "   Failed: ${FAILED}"
          echo "   Success Rate: $(awk "BEGIN {printf \"%.1f\", ($PASSED / $TOTAL) * 100}")%"
          echo ""
          echo "ðŸ”’ CAPTCHA Statistics:"
          echo "   CAPTCHA Encounters: ${CAPTCHA_COUNT}"
          echo "   CAPTCHA Rate: $(awk "BEGIN {printf \"%.1f\", ($CAPTCHA_COUNT / $TOTAL) * 100}")%"
          echo ""
          echo "ðŸŒ IP Diversity:"
          echo "   Unique IPs: ${#IP_RESULTS[@]}"
          for ip in "${!IP_RESULTS[@]}"; do
            echo "   - $ip: ${IP_RESULTS[$ip]} tests"
          done
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

          # Save summary
          cat > summary.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "total_tests": ${TOTAL},
            "passed": ${PASSED},
            "failed": ${FAILED},
            "success_rate": $(awk "BEGIN {printf \"%.1f\", ($PASSED / $TOTAL) * 100}"),
            "captcha_count": ${CAPTCHA_COUNT},
            "captcha_rate": $(awk "BEGIN {printf \"%.1f\", ($CAPTCHA_COUNT / $TOTAL) * 100}"),
            "unique_ips": ${#IP_RESULTS[@]}
          }
          EOF

      - name: Upload analysis
        uses: actions/upload-artifact@v4
        with:
          name: analysis-summary
          path: summary.json

  report:
    name: Generate Report
    runs-on: ubuntu-latest
    needs: analyze-results
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download analysis
        uses: actions/download-artifact@v4
        with:
          name: analysis-summary
          path: analysis/

      - name: Create markdown report
        run: |
          cat > GITHUB-ACTIONS-LEARNING-REPORT.md << 'EOF'
          # ðŸ¤– GitHub Actions Learning Report

          **Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          **Workflow**: Social Media Training - Learning Phase

          ---

          ## ðŸ“Š Test Results

          $(cat analysis/summary.json | jq -r '
            "**Total Tests**: \(.total_tests)\n" +
            "**Passed**: \(.passed)\n" +
            "**Failed**: \(.failed)\n" +
            "**Success Rate**: \(.success_rate)%\n" +
            "**CAPTCHA Encounters**: \(.captcha_count)\n" +
            "**CAPTCHA Rate**: \(.captcha_rate)%\n" +
            "**Unique IPs Used**: \(.unique_ips)"
          ')

          ---

          ## ðŸŽ¯ Key Learnings

          1. **IP Diversity**: GitHub Actions provides multiple unique IPs
          2. **Success Rate**: Compare to local testing (93.3%)
          3. **CAPTCHA Behavior**: Different from local environment?
          4. **Performance**: Speed differences across runners

          ---

          ## ðŸ“ Artifacts Generated

          - Test results per site
          - Test logs with detailed output
          - AgentDB metrics
          - IP information per runner

          ---

          **Next Steps**: Analyze patterns and prepare Twitter-specific strategy
          EOF

      - name: Comment on commit (if triggered by push)
        if: github.event_name == 'push'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('GITHUB-ACTIONS-LEARNING-REPORT.md', 'utf8');

            github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: report
            });
